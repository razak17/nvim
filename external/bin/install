#!/bin/sh
#Set Variable to master is not set differently
BRANCH="${BRANCH:-main}"
set -o nounset # error when referencing undefined variable
set -o errexit # exit when command fails
RVIM_GIT_PATH="$HOME/.dots/rvim/"
RVIM_CONFIG_PATH="$HOME/.config/rvim/"

lsp_path='.cache/rvim/nvim_lsp'
neovim_py='.cache/rvim/venv/neovim'

asktoinstallgo() {
	echo "Please install go before continuing with install" && exit
}

asktoinstallnode() {
	echo "Please install node before continuing with install" && exit
}

asktoinstallpip() {
	echo "Please install pip3 before continuing with install" && exit
}

moveoldlvim() {
	echo "Not installing rvim"
	echo "Please remove $RVIM_CONFIG_PATH and $RVIM_GIT_PATH paths before installing"
	exit
}

removeoldconfig() {
	echo '!!Warning!! -> Removing all lunarvim related config because of the --overwrite flag'
	rm -rf "$HOME/.local/share/rvim"
	rm -rf "$HOME/.cache/rvim"
	rm -rf "$HOME/.config/rvim"
}

installpacker() {
	git clone https://github.com/wbthomason/packer.nvim ~/.local/share/rvim/site/pack/packer/opt/packer.nvim
}

createDirs() {
	mkdir -p "$HOME/.dots"
	mkdir -p "$HOME/.cache/rvim"
	mkdir -p "$HOME/.cache/rvim/dap"
	mkdir -p "$HOME/.cache/rvim/session"
	mkdir -p "$HOME/.cache/rvim/undodir"
	mkdir -p "$HOME/.cache/rvim/nvim_lsp"
	mkdir -p "$HOME/.local/share/rvim"
	mkdir -p "$HOME/$lsp_path"
}

pythonVenvInit() {
	mkdir -p ~/$neovim_py
	python3 -m venv ~/$neovim_py
	~/$neovim_py/bin/pip install -U setuptools pynvim jedi neovim-remote ueberzug
	pip install ueberzug pynvim neovim-remote isort yapf black flake8 pylint mypy
}

nodeHostInit() {
	npm i -g sql-language-server typescript-language-server typescript pyright
	npm i -g neovim prettier eslint bash-language-server tree-sitter-cli
	npm i -g svelte-language-server vim-language-server yaml-language-server
	npm i -g vscode-langservers-extracted dockerfile-language-server-nodejs graphql-language-service-cli
}

golangInit() {
	go get github.com/mattn/efm-langserver
	go get golang.org/x/tools/gopls@latest
	go get github.com/golangci/golangci-lint/cmd/golangci-lint@v1.41.1
}

installextra() {
	sudo pacman -S ripgrep fzf
}

rconf() {
	/usr/bin/git --git-dir="$RVIM_GIT_PATH" --work-tree="$RVIM_CONFIG_PATH" "$@"
}

importRvim() {
	git clone --branch "$BRANCH" --bare https://github.com/razak17/nvim "$RVIM_GIT_PATH"
	mkdir -p "$RVIM_CONFIG_PATH"
	cd "$RVIM_CONFIG_PATH" || exit
	rconf checkout
	if [ $? = 0 ]; then
		echo "Checked out dotfiles..."
	else
		mkdir -p ~/.config-backup-rvim
		echo "Backing up pre-existing dot files."
		rconf checkout 2>&1 | grep -E "\s+\." | awk {'print $1'} | xargs -I{} mv {} ~/.config-backup-rvim/{}
	fi
	rconf checkout
	rconf config --local status.showUntrackedFiles no
	echo "Config clone done"
	echo "Old files have been moved to ~/.config-backup-rvim"
}

cloneconfig() {
	# check existing config
	[ -d "$RVIM_CONFIG_PATH" ] || [ -d "$RVIM_GIT_PATH" ] && moveoldlvim

	# install go
	(command -v go >/dev/null && echo "go installed, moving on...") || asktoinstallgo

	# install node and neovim support
	(command -v node >/dev/null && echo "node installed, moving on...") || asktoinstallnode

	# install pip
	(command -v pip3 >/dev/null && echo "pip installed, moving on...") || asktoinstallpip

	# create dirs
	echo "Creating default directories"
	createDirs

	# Cloning rvim configuration
	echo "Installing rvim"
	importRvim

	if [ -e "$HOME/.local/share/rvim/site/pack/packer/opt/packer.nvim" ]; then
		echo 'packer already installed'
	else
		installpacker
	fi

	printf "Would you like to install npm packages now (y/n)? "
	read -r answer
	[ "$answer" != "${answer#[Yy]}" ] && nodeHostInit

	printf "Would you like to install pip packages now (y/n)? "
	read -r answer
	[ "$answer" != "${answer#[Yy]}" ] && pythonVenvInit

	printf "Would you like to install go packages now (y/n)? "
	read -r answer
	[ "$answer" != "${answer#[Yy]}" ] && golangInit

	printf "Would you like to install extra packages now (y/n)? "
	read -r answer
	[ "$answer" != "${answer#[Yy]}" ] && installextra

	sudo cp --force "$HOME/.config/nvim/external/bin/rvim" "/usr/local/bin"
}

while [ "$#" -gt 0 ]; do
	curr=$1
	shift

	case "$curr" in
	-py)
		pythonVenvInit
		;;
	-node)
		nodeHostInit
		;;
	-go)
		golangInit
		;;
	*--overwrite*)
		removeoldconfig
		;;
	*--all*)
		cloneconfig
		;;
	*) echo "Unavailable command... $curr" ;;
	esac
done
