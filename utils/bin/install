#!/bin/sh
#Set Variable to master is not set differently

RVIM_CONFIG_PATH="${RVIM_CONFIG_PATH:-"$XDG_CONFIG_HOME/rvim"}"
RV_BRANCH="${RV_BRANCH:-"main"}"
RV_REMOTE="${RV_REMOTE:-razak17/nvim.git}"

lsp_path='.cache/rvim/nvim_lsp'
neovim_py='.cache/rvim/venv/neovim'

asktoinstallgit() {
	echo "git not found, please install git"
	exit
}

asktoinstallgo() {
	echo "Please install go before continuing with install" && exit
}

asktoinstallnode() {
	echo "Please install node before continuing with install" && exit
}

asktoinstallpip() {
	echo "Please install pip3 before continuing with install" && exit
}

moveoldrvim() {
	echo "Not installing rvim"
	echo "Please remove $RVIM_CONFIG_PATH path before installing"
	exit
}

installpacker() {
	git clone https://github.com/wbthomason/packer.nvim ~/.local/share/rvim/site/pack/packer/opt/packer.nvim
}

createDirs() {
	mkdir -p "$HOME/.dots"
	mkdir -p "$HOME/.cache/rvim"
	mkdir -p "$HOME/.cache/rvim/dap"
	mkdir -p "$HOME/.cache/rvim/shada"
	mkdir -p "$HOME/.cache/rvim/session"
	mkdir -p "$HOME/.cache/rvim/undodir"
	mkdir -p "$HOME/.cache/rvim/nvim_lsp"
	mkdir -p "$HOME/.cache/rvim/telescope"
	mkdir -p "$HOME/.local/share/rvim"
	mkdir -p "$HOME/$lsp_path"
}

pythonVenvInit() {
	mkdir -p ~/$neovim_py
	python3 -m venv ~/$neovim_py
	~/$neovim_py/bin/pip3 install -U setuptools pynvim jedi neovim-remote
}

pythonExtra() {
	pip3 install ueberzug yapf black flake8 pylint mypy black isort
}

golangInit() {
	go install github.com/mattn/efm-langserver
	go install golang.org/x/tools/gopls@latest
	go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.43.0
}

installExtra() {
	sudo pacman -S ripgrep fzf cppcheck stylua shfmt shellcheck
}

nodeExtra() {
	npm install -g tree-sitter-cli eslint prettier_d_slim esint_d neovim
}

msg() {
  text="$1"
  div_width="80"
  printf "%${div_width}s\n" ' ' | tr ' ' -
  printf "%s\n" "$text"
}

importRvim() {
  msg "Cloning rVim configuration"
  if ! git clone --branch "$RV_BRANCH" \
    --depth 1 "https://github.com/${RV_REMOTE}" "$RVIM_CONFIG_PATH"; then
    echo "Failed to clone repository. Installation failed."
    exit 1
  fi
}

cloneconfig() {
	# check existing config
	[ -d "$RVIM_CONFIG_PATH" ] && moveoldrvim

	# install go
	(command -v go >/dev/null && echo "go installed, moving on...") || asktoinstallgo

	# install node and neovim support
	(command -v node >/dev/null && echo "node installed, moving on...") || asktoinstallnode

	# install pip
	(command -v pip3 >/dev/null && echo "pip installed, moving on...") || asktoinstallpip

	# create dirs
	echo "Creating default directories"
	createDirs

	# Cloning rvim configuration
	echo "Installing rvim"
	importRvim

	# Install core python packages
	printf "Would you like to initialize python now (y/n)? "
	read -r answer
	[ "$answer" != "${answer#[Yy]}" ] && pythonVenvInit

	# install node and neovim support
	(command -v git >/dev/null && echo "git installed, moving on...") || asktoinstallgit

	if [ -e "$HOME/.local/share/rvim/site/pack/packer/opt/packer.nvim" ]; then
		echo 'packer already installed'
	else
		installpacker
	fi

	printf "Would you like to install node packages now (y/n)? "
	read -r answer
	[ "$answer" != "${answer#[Yy]}" ] && nodeExtra

	printf "Would you like to install pip packages now (y/n)? "
	read -r answer
	[ "$answer" != "${answer#[Yy]}" ] && pythonExtra

	printf "Would you like to install go packages now (y/n)? "
	read -r answer
	[ "$answer" != "${answer#[Yy]}" ] && golangInit

	printf "Would you like to install extra packages now (y/n)? "
	read -r answer
	[ "$answer" != "${answer#[Yy]}" ] && installExtra

	sudo cp --force "$HOME/.config/rvim/utils/bin/rvim" "$HOME/.local/bin"
}

while [ "$#" -gt 0 ]; do
	curr=$1
	shift

	case "$curr" in
	-py)
		pythonVenvInit
		;;
	-node)
		nodeHostInit
		;;
	-go)
		golangInit
		;;
	*--all*)
		cloneconfig
		;;
	*) echo "Unavailable command... $curr" ;;
	esac
done
